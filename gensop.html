<!DOCTYPE html>
<html lang="es">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>The Puzzles</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <!-- Incluye todas las nuevas fuentes de Google Fonts -->
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;600;700&family=Permanent+Marker&family=Balsamiq+Sans&family=Alegreya+Sans&family=Lobster&family=Cabin+Sketch&family=Pacifico&family=Josefin+Sans&family=Handlee&family=Righteous&family=Roboto+Mono&display=swap" rel="stylesheet">
    <style>
        /* Estilo Base y Fondo Moderno */
        body {
            font-family: 'Inter', sans-serif;
            background-color: #eef2f5; /* Color base muy claro */
            /* Sutil degradado y patr√≥n de fondo geom√©trico (Tri√°ngulos muy suaves) */
            background-image: linear-gradient(135deg, #f8fafc 25%, transparent 25%), 
                              linear-gradient(225deg, #f8fafc 25%, transparent 25%), 
                              linear-gradient(45deg, #f8fafc 25%, transparent 25%), 
                              linear-gradient(315deg, #f8fafc 25%, #eef2f5 25%);
            background-position: 10px 0, 10px 0, 0 0, 0 0;
            background-size: 20px 20px;
            background-repeat: repeat;
            min-height: 100vh;
        }
        
        /* Font Classes (Aplicadas solo al t√≠tulo) */
        .font-permanent-marker { font-family: 'Permanent Marker', cursive !important; }
        .font-balsamiq-sans { font-family: 'Balsamiq Sans', cursive !important; }
        .font-alegreya-sans { font-family: 'Alegreya Sans', sans-serif !important; }
        .font-lobster { font-family: 'Lobster', cursive !important; }
        .font-cabin-sketch { font-family: 'Cabin Sketch', cursive !important; }
        .font-pacifico { font-family: 'Pacifico', cursive !important; }
        .font-josefin-sans { font-family: 'Josefin Sans', sans-serif !important; }
        .font-handlee { font-family: 'Handlee', cursive !important; }
        .font-righteous { font-family: 'Righteous', cursive !important; }
        .font-roboto-mono { font-family: 'Roboto Mono', monospace !important; }
        /* --- End Font Classes --- */

        /* Estilo espec√≠fico para la cuadr√≠cula */
        .grid-container {
            display: grid;
            border: 2px solid #000000; /* Borde negro */
            background-color: transparent; /* FONDO TRANSPARENTE EN PANTALLA */
            box-shadow: 0 4px 12px rgba(0, 0, 0, 0.1);
            border-radius: 0.75rem; /* Esquinas redondeadas */
            overflow: hidden; 
        }
        .grid-cell {
            display: flex;
            justify-content: center;
            align-items: center;
            font-size: 0.8rem;
            font-weight: 700; 
            color: #000000; /* Letras Oscuras para pantalla y print */
            padding: 0.1rem; 
            user-select: none;
            cursor: default;
        }

        /* Estilo para el t√≠tulo de la sopa */
        #outputTitle {
            font-size: 1.8rem; 
            letter-spacing: 0.1em;
            text-shadow: 3px 3px 6px rgba(0,0,0,0.15); 
            transition: all 0.3s ease;
        }

        /* ESTILOS DE PREVISUALIZACI√ìN EN PANTALLA Y EN IMPRESI√ìN (Lista de Palabras) */
        .word-list-preview {
            /* 3 Columnas */
            grid-template-columns: repeat(3, 1fr);
            /* Tama√±o de fuente m√°s peque√±o para el modo compacto */
            font-size: 0.75rem; /* ~12px */
            /* Espacios entre elementos de lista */
            gap-x: 0.75rem;
            gap-y: 0.3rem;
        }

        /* CUADRADO 3D SOLICITADO (Sombra Gris/Negra) */
        .checkbox-3d {
            height: 0.8rem;
            width: 0.8rem;
            background-color: transparent; 
            border-radius: 0.1rem; 
            flex-shrink: 0;
            box-shadow: 2px 2px 0 0 rgba(107, 114, 128, 0.7); 
        }
        
        /* ============================================== */
        /* MEDIA PRINT: Optimizaci√≥n para Impresi√≥n (A4) */
        /* ============================================== */
        @media print {
            .no-print { display: none !important; }
            body { 
                margin: 0 !important; 
                padding: 0 !important; 
                background: none !important; 
                /* Se puede forzar el tama√±o si es necesario, pero es mejor dejar al navegador */
            }
            
            /* Eliminar fondo, borde y sombra del contenedor principal de la app */
            #app {
                background-color: transparent !important;
                box-shadow: none !important;
                border: none !important;
                padding: 0 !important;
                margin: 0 auto !important;
                max-width: none !important;
            }

            /* Asegura que el √°rea imprimible sea el foco */
            .printable-area {
                margin: 0 !important;
                padding: 0.25in !important; /* Margen de impresi√≥n ULTRA REDUCIDO (0.6 cm) */
                box-shadow: none !important;
                max-width: none !important;
                width: 100% !important;
                border: none !important;
                background-color: transparent !important; /* ELIMINA EL FONDO BLANCO EXTRA */
            }

            /* T√≠tulo en impresi√≥n: centrado y espacio ultra reducido */
            #outputTitle {
                font-size: 1.7rem !important; 
                margin-bottom: 0.5rem !important; /* Espacio reducido: ~0.5 cm */
                text-shadow: none;
                width: 100% !important;
            }

            /* Cuadr√≠cula - centrada y aspecto cuadrado */
            #puzzleOutput {
                width: 100% !important;
                max-width: 7in !important; /* Ancho t√≠pico de impresi√≥n */
                margin: 0 auto !important; /* Centra la cuadr√≠cula */
            }

            /* Contenedor de la Cuadr√≠cula: Redondeado y Transparente en Impresi√≥n */
            .grid-container {
                border-width: 2px !important;
                border-color: #000 !important;
                border-radius: 0.75rem !important; /* BORDE REDONDEADO FORZADO */
                background-color: transparent !important; /* FONDO TRANSPARENTE EN IMPRESI√ìN */
                box-shadow: none !important; 
            }

            /* Letras de la cuadr√≠cula: MUY OSCURAS (Ya definido globalmente, se mantiene) */
            .grid-cell {
                color: #000000 !important; 
                font-size: 0.8rem !important; 
            }

            /* Lista de Palabras - Borde ELIMINADO y espacio ultra reducido */
            #wordListContainer {
                margin-top: 0.5rem !important; /* ESPACIO REDUCIDO entre cuadr√≠cula y lista */
                background: none !important;
                border: none !important; 
                box-shadow: none !important;
                padding: 0 !important; /* Elimina padding para m√°s espacio */
            }
            
            /* Asegura que la lista de palabras use los estilos compactos definidos en .word-list-preview */
            #wordListOutput {
                grid-template-columns: repeat(3, 1fr) !important;
                font-size: 0.75rem !important;
                gap-x: 0.75rem;
                gap-y: 0.3rem; 
            }

            .checkbox-3d {
                /* Sombra negra para impresi√≥n */
                height: 0.65rem !important;
                width: 0.65rem !important;
                box-shadow: 1.5px 1.5px 0 0 rgba(0, 0, 0, 0.7);
            }
        }
    </style>
</head>
<body class="p-4 sm:p-8">

    <!-- Contenedor principal con estilo flotante y moderno -->
    <div id="app" class="max-w-5xl mx-auto bg-white p-6 sm:p-10 rounded-3xl shadow-2xl transition duration-500 hover:shadow-3xl">

        <!-- √Årea de Control (No Imprimir) -->
        <div class="no-print">
            <h1 class="text-4xl font-extrabold text-gray-900 mb-2 flex items-center">
                <span class="text-indigo-600 mr-3 text-5xl">‚ú®</span> The Puzzles
            </h1>
            <p class="text-base text-gray-500 mb-8 border-b pb-4">Personaliza, genera e imprime tu puzzle con un acabado profesional.</p>

            <!-- Inputs y Configuraci√≥n -->
            <div class="space-y-6 mb-8 p-6 bg-gray-50 rounded-2xl border border-gray-100 shadow-inner">
                
                <!-- Secci√≥n 1: Configuraci√≥n General -->
                <div class="space-y-4">
                    <h2 class="text-xl font-bold text-gray-700 border-b pb-1">Configuraci√≥n del Puzzle</h2>
                    <div class="flex flex-col md:flex-row space-y-4 md:space-y-0 md:space-x-4">
                        <!-- T√≠tulo, ahora sin valor inicial en HTML -->
                        <input type="text" id="puzzleTitle" placeholder="T√≠tulo de la Sopa de Letras (Ej: Frutas)"
                            class="flex-1 p-3 border border-gray-300 rounded-xl focus:ring-indigo-500 focus:border-indigo-500 text-base shadow-sm transition">
                        
                        <select id="gridSize"
                            class="p-3 border border-gray-300 rounded-xl focus:ring-indigo-500 focus:border-indigo-500 text-base shadow-sm w-full md:w-48 transition">
                            <!-- Tama√±o 15x15 ahora por defecto -->
                            <option value="15" selected>Tama√±o 15x15</option>
                            <option value="20">Tama√±o 20x20</option>
                            <option value="25">Tama√±o 25x25</option>
                        </select>

                        <!-- Selector de Fuente -->
                        <select id="fontSelect"
                            class="p-3 border border-gray-300 rounded-xl focus:ring-indigo-500 focus:border-indigo-500 text-base shadow-sm w-full md:w-56 transition">
                            <!-- Opciones pobladas por JS -->
                        </select>
                    </div>
                </div>

                <!-- Secci√≥n 2: Gesti√≥n de Palabras -->
                <!-- Separaci√≥n sutil pt-8 -->
                <div class="space-y-4 pt-8">
                    <h2 class="text-xl font-bold text-gray-700 border-b pb-1">Palabras a Incluir</h2>
                    <div class="flex flex-col sm:flex-row space-y-3 sm:space-y-0 sm:space-x-4">
                        <input type="text" id="wordInput" placeholder="Escribe una palabra y presiona Enter o A√±adir"
                            class="flex-1 p-3 border border-gray-300 rounded-xl focus:ring-pink-500 focus:border-pink-500 text-base shadow-sm transition">
                        <button id="addWordBtn"
                            class="px-6 py-3 bg-pink-500 text-white font-semibold rounded-xl shadow-lg hover:bg-pink-600 transition duration-200 transform hover:scale-[1.03] active:scale-95 text-base">
                            + A√±adir
                        </button>
                    </div>

                    <!-- Lista de Palabras A√±adidas -->
                    <div id="wordListDisplay" class="flex flex-wrap gap-3 min-h-12 p-3 border-2 border-dashed border-gray-300 rounded-xl bg-white shadow-inner mt-4">
                        <p class="text-gray-400 italic text-sm" id="emptyMessage">A√∫n no has a√±adido palabras. Intenta con "SOL", "LUNA", "ESTRELLA".</p>
                    </div>
                </div>
            </div>

            <!-- Botones de Acci√≥n Finales - ANCHO 50% (w-1/2) y ALTURA DELGADA (py-1) -->
            <div class="flex flex-col sm:flex-row justify-center space-y-4 sm:space-y-0 sm:space-x-6 mb-10">
                <button id="generateBtn"
                    class="w-1/2 mx-auto sm:mx-0 px-8 py-1 bg-indigo-500 text-white font-medium text-base rounded-xl shadow-md hover:bg-indigo-600 transition duration-300 transform hover:scale-[1.01] active:scale-95">
                    Generar Puzzle
                </button>
                <button id="printBtn"
                    class="w-1/2 mx-auto sm:mx-0 px-8 py-1 bg-green-500 text-white font-medium text-base rounded-xl shadow-md hover:bg-green-600 transition duration-300 transform hover:scale-[1.01] active:scale-95 disabled:bg-gray-400 flex items-center justify-center"
                    disabled>
                    <span class="text-lg mr-2" aria-hidden="true">üñ®Ô∏è</span>
                    Imprimir / Descargar PDF
                </button>
            </div>
            
        </div>

        <!-- √Årea Imprimible (Resultado) - ESTRUCTURA SIMPLIFICADA Y LIMPIA -->
        <!-- Se ajusta el padding en pantalla (p-4) para coincidir con la vista compacta -->
        <div id="printableArea" class="printable-area p-4 sm:p-6 rounded-xl border border-gray-200 bg-white shadow-lg transition duration-500" style="display: none;">
            
            <!-- T√≠tulo (mb-2 para un margen reducido en pantalla) -->
            <h1 id="outputTitle" class="text-3xl sm:text-4xl font-extrabold text-center mb-2 text-gray-900 uppercase font-permanent-marker w-full"></h1>
            
            <!-- Cuadr√≠cula (centrada en la pantalla) -->
            <div id="puzzleOutput" class="mx-auto aspect-square" style="max-width: 600px;">
                <!-- Aqu√≠ se renderizar√° la cuadr√≠cula --></div>
            
            <!-- Lista de Palabras (mt-2 para un margen reducido en pantalla) -->
            <div id="wordListContainer" class="mt-2 mx-auto p-4 rounded-xl" style="max-width: 600px;">
                <!-- Se aplica la clase word-list-preview para 3 columnas y fuente peque√±a -->
                <div id="wordListOutput" class="word-list-preview text-gray-800 grid gap-x-4 gap-y-2">
                    <!-- Aqu√≠ se renderizar√° la lista de palabras --></div>
            </div>
            
        </div>

        <!-- √Årea de Mensajes (Modal) -->
        <div id="messageBox" class="fixed inset-0 bg-black bg-opacity-60 flex items-center justify-center p-4 z-50 hidden transition-opacity duration-300">
            <div class="bg-white p-8 rounded-xl shadow-2xl max-w-md w-full text-center transform transition-transform duration-300 scale-95" id="messageContent">
                <p id="messageText" class="text-xl font-semibold text-gray-800 mb-6"></p>
                <button id="closeMessageBtn" class="px-6 py-2 bg-indigo-500 text-white font-semibold rounded-lg hover:bg-indigo-600 transition duration-150 shadow-md">Aceptar</button>
            </div>
        </div>

    </div>

    <script type="module">
        // =========================================================================
        // Configuraci√≥n y Variables Globales
        // =========================================================================
        const wordList = [];
        // Alfabeto extendido para incluir √ë y vocales acentuadas
        const alphabet = 'ABCDEFGHIJKLMNOPQRSTUVWXYZ√ë√Å√â√ç√ì√ö'; 
        const DIRECTIONS = [
            [0, 1],   // Este (E)
            [1, 0],   // Sur (S)
            [0, -1],  // Oeste (W)
            [-1, 0],  // Norte (N)
            [1, 1],   // Sureste (SE)
            [-1, 1],  // Noreste (NE)
            [1, -1],  // Suroeste (SW)
            [-1, -1]  // Noroeste (NW)
        ];
        
        // NOMBRES SIMPLIFICADOS para el selector (SOLICITADO)
        const FONT_OPTIONS = {
            'Permanent Marker': 'Marcador',
            'Balsamiq Sans': 'Juguet√≥n',
            'Alegreya Sans': 'Clara',
            'Lobster': 'Decorativa',
            'Cabin Sketch': 'Boceto',
            'Pacifico': 'Manuscrita',
            'Josefin Sans': 'Geom√©trica',
            'Handlee': 'Escrita a mano',
            'Righteous': 'Fuerte',
            'Roboto Mono': 'Monospacio'
        };
        const DEFAULT_FONT_CLASS = 'font-permanent-marker';
        
        // Clave para el contador de puzzles en localStorage
        const PUZZLE_COUNT_KEY = 'puzzleCount'; 


        // Referencias a elementos del DOM
        const wordInput = document.getElementById('wordInput');
        const wordListDisplay = document.getElementById('wordListDisplay');
        const emptyMessage = document.getElementById('emptyMessage');
        const puzzleTitle = document.getElementById('puzzleTitle');
        const generateBtn = document.getElementById('generateBtn');
        const printBtn = document.getElementById('printBtn');
        const puzzleOutput = document.getElementById('puzzleOutput');
        const outputTitle = document.getElementById('outputTitle');
        const wordListOutput = document.getElementById('wordListOutput');
        const gridSizeSelect = document.getElementById('gridSize');
        const printableArea = document.getElementById('printableArea');
        const messageBox = document.getElementById('messageBox');
        const messageText = document.getElementById('messageText');
        const closeMessageBtn = document.getElementById('closeMessageBtn');
        const fontSelect = document.getElementById('fontSelect'); 
        const wordListContainer = document.getElementById('wordListContainer');
        
        // =========================================================================
        // L√≥gica de Contador de Puzzles (Local Storage)
        // =========================================================================

        function getNextPuzzleNumber() {
            // Obtiene el n√∫mero actual de localStorage o 0 si no existe
            let currentCount = parseInt(localStorage.getItem(PUZZLE_COUNT_KEY) || '0', 10);
            return currentCount;
        }

        function incrementPuzzleCount() {
            // Incrementa y guarda el nuevo n√∫mero
            let currentCount = getNextPuzzleNumber();
            let newCount = currentCount + 1;
            localStorage.setItem(PUZZLE_COUNT_KEY, newCount.toString());
        }

        // =========================================================================
        // L√≥gica de UI - Mensajes y Palabras
        // =========================================================================
        
        function showMessage(text) {
            messageText.textContent = text;
            messageBox.classList.remove('hidden');
            // A√±adir efectos de transici√≥n
            document.getElementById('messageContent').classList.remove('scale-95');
            document.getElementById('messageContent').classList.add('scale-100');
        }

        closeMessageBtn.addEventListener('click', () => {
            document.getElementById('messageContent').classList.remove('scale-100');
            document.getElementById('messageContent').classList.add('scale-95');
            setTimeout(() => {
                messageBox.classList.add('hidden');
            }, 300); // Esperar que termine la transici√≥n
        });

        function formatWord(word) {
            // Limpia y convierte a may√∫sculas. Ahora permite √ë y vocales acentuadas.
            return word.toUpperCase().replace(/[^A-Z√ë√Å√â√ç√ì√ö]/g, '');
        }

        function addWord() {
            let word = wordInput.value.trim();
            if (word.length === 0) {
                showMessage("Por favor, introduce una palabra v√°lida.");
                return;
            }

            const cleanWord = formatWord(word);
            const maxLen = parseInt(gridSizeSelect.value);

            if (cleanWord.length === 0) {
                showMessage("La palabra solo debe contener letras (A-Z, √ë, √Å, √â, √ç, √ì, √ö).");
                return;
            }

            if (cleanWord.length > maxLen) {
                showMessage(`La palabra es demasiado larga (${cleanWord.length} letras). El tama√±o m√°ximo actual de la cuadr√≠cula es ${maxLen}x${maxLen}.`);
                return;
            }

            if (wordList.includes(cleanWord)) {
                showMessage("Esta palabra ya ha sido a√±adida.");
                return;
            }

            wordList.push(cleanWord);
            wordInput.value = '';
            renderWordListDisplay();
            
            // Habilitar el bot√≥n de generar si hay palabras
            generateBtn.disabled = false;
        }

        function removeWord(wordToRemove) {
            const index = wordList.indexOf(wordToRemove);
            if (index > -1) {
                wordList.splice(index, 1);
            }
            renderWordListDisplay();

            if (wordList.length === 0) {
                generateBtn.disabled = true;
                printBtn.disabled = true;
                printableArea.style.display = 'none';
            }
        }

        function renderWordListDisplay() {
            wordListDisplay.innerHTML = '';
            if (wordList.length === 0) {
                wordListDisplay.appendChild(emptyMessage);
                emptyMessage.classList.remove('hidden');
            } else {
                emptyMessage.classList.add('hidden');
                wordList.forEach(word => {
                    const tag = document.createElement('span');
                    // Estilo de etiqueta mejorado
                    tag.className = 'flex items-center bg-pink-100 text-pink-800 text-sm font-medium px-4 py-1 rounded-full cursor-pointer shadow-md hover:bg-pink-200 transition duration-150';
                    tag.innerHTML = `${word} <button class="ml-2 text-pink-600 hover:text-red-700 font-bold leading-none text-xl" data-word="${word}">&times;</button>`;
                    tag.querySelector('button').addEventListener('click', (e) => removeWord(e.target.dataset.word));
                    wordListDisplay.appendChild(tag);
                });
            }
        }

        // =========================================================================
        // Algoritmo de Generaci√≥n de Sopa de Letras
        // =========================================================================

        function createEmptyGrid(size) {
            return Array.from({ length: size }, () => Array(size).fill(''));
        }

        function placeWord(grid, word, size) {
            // Intentar colocar la palabra 500 veces antes de rendirse
            for (let attempts = 0; attempts < 500; attempts++) {
                const startX = Math.floor(Math.random() * size);
                const startY = Math.floor(Math.random() * size);
                const [dx, dy] = DIRECTIONS[Math.floor(Math.random() * DIRECTIONS.length)];
                
                let fits = true;
                
                // 1. Verificar si cabe
                if (startX + word.length * dx < 0 || startX + word.length * dx > size ||
                    startY + word.length * dy < 0 || startY + word.length * dy > size) {
                    continue; // No cabe en esta direcci√≥n
                }

                // 2. Verificar si no hay conflicto
                for (let i = 0; i < word.length; i++) {
                    const x = startX + i * dx;
                    const y = startY + i * dy;
                    
                    if (grid[x][y] !== '' && grid[x][y] !== word[i]) {
                        fits = false;
                        break;
                    }
                }

                // 3. Colocar la palabra
                if (fits) {
                    for (let i = 0; i < word.length; i++) {
                        const x = startX + i * dx;
                        const y = startY + i * dy;
                        grid[x][y] = word[i];
                    }
                    return true;
                }
            }
            return false; // No se pudo colocar la palabra
        }

        function generatePuzzle(words, size) {
            const grid = createEmptyGrid(size);
            const placedWords = [];

            // Ordenar las palabras de mayor a menor longitud para un mejor empaquetamiento
            const sortedWords = [...words].sort((a, b) => b.length - a.length);

            sortedWords.forEach(word => {
                if (word.length <= size) {
                    if (placeWord(grid, word, size)) {
                        placedWords.push(word);
                    } else {
                        console.warn(`No se pudo colocar la palabra: ${word}`);
                    }
                }
            });

            // Rellenar espacios vac√≠os
            for (let i = 0; i < size; i++) {
                for (let j = 0; j < size; j++) {
                    if (grid[i][j] === '') {
                        grid[i][j] = alphabet.charAt(Math.floor(Math.random() * alphabet.length));
                    }
                }
            }
            
            // Devolver la cuadr√≠cula y las palabras que realmente se colocaron
            return { grid, placedWords };
        }

        // =========================================================================
        // L√≥gica de Renderizado
        // =========================================================================

        function renderPuzzle(grid, placedWords, title) {
            const size = grid.length;
            
            outputTitle.textContent = title.toUpperCase() || "SOPA DE LETRAS";
            
            // Aplicar la fuente seleccionada SOLO al t√≠tulo (IMPORTANTE)
            // 1. Eliminar cualquier clase de fuente anterior
            outputTitle.className = outputTitle.className.split(' ').filter(c => !c.startsWith('font-')).join(' ');
            // 2. Aplicar la nueva clase de fuente seleccionada
            outputTitle.classList.add(fontSelect.value);
            // Se usa mb-2 en el HTML y se ajusta con CSS de print para m√°s precisi√≥n.
            outputTitle.classList.add('text-3xl', 'sm:text-4xl', 'font-extrabold', 'text-center', 'mb-2', 'text-gray-900', 'uppercase', 'w-full');

            // 1. Renderizar la cuadr√≠cula
            puzzleOutput.innerHTML = '';
            puzzleOutput.style.gridTemplateColumns = `repeat(${size}, 1fr)`;
            // Aplicar estilos para que la cuadr√≠cula se centre en la vista de pantalla
            puzzleOutput.className = 'grid-container mx-auto aspect-square'; 
            
            grid.forEach(row => {
                row.forEach(letter => {
                    const cell = document.createElement('div');
                    cell.className = 'grid-cell';
                    cell.textContent = letter;
                    puzzleOutput.appendChild(cell);
                });
            });
            
            // 2. Renderizar la lista de palabras (con checklist 3D)
            wordListOutput.innerHTML = '';
            
            placedWords.sort().forEach(word => {
                const item = document.createElement('div');
                // Asegura que las letras de la lista se vean con el mismo tama√±o compacto
                item.className = 'flex items-center text-sm font-medium tracking-wider text-gray-800 space-x-2'; 
                // √çcono de checklist 3D (nueva clase checkbox-3d)
                item.innerHTML = `<span class="checkbox-3d flex-shrink-0"></span><span class="truncate">${word}</span>`;
                wordListOutput.appendChild(item);
            });
            
            printableArea.style.display = 'block'; // Mostrar como bloque para el flujo vertical
        }

        // =========================================================================
        // Manejadores de Eventos
        // =========================================================================
        
        // Funci√≥n para poblar el selector de fuentes
        function populateFontSelector() {
            for (const key in FONT_OPTIONS) {
                const option = document.createElement('option');
                // Convierte el nombre de la fuente a una clase CSS v√°lida
                option.value = `font-${key.toLowerCase().replace(/ /g, '-')}`;
                // Usa solo el descriptor (SOLICITADO)
                option.textContent = FONT_OPTIONS[key]; 
                if (option.value === DEFAULT_FONT_CLASS) {
                    option.selected = true;
                }
                fontSelect.appendChild(option);
            }
        }

        document.getElementById('addWordBtn').addEventListener('click', addWord);
        
        wordInput.addEventListener('keydown', (e) => {
            if (e.key === 'Enter') {
                e.preventDefault();
                addWord();
            }
        });

        // Listener para el cambio de fuente (aplica solo al t√≠tulo)
        fontSelect.addEventListener('change', () => {
            if (printableArea.style.display !== 'none') {
                // Si la sopa est√° visible, aplicamos la nueva clase de fuente inmediatamente SOLO al t√≠tulo.
                outputTitle.className = outputTitle.className.split(' ').filter(c => !c.startsWith('font-')).join(' ');
                outputTitle.classList.add(fontSelect.value);
                outputTitle.classList.add('text-3xl', 'sm:text-4xl', 'font-extrabold', 'text-center', 'mb-2', 'text-gray-900', 'uppercase', 'w-full');
            }
        });

        generateBtn.addEventListener('click', () => {
            if (wordList.length === 0) {
                showMessage("¬°Ups! Parece que olvidaste a√±adir palabras. ¬°Elige algunas para empezar!");
                return;
            }
            
            generateBtn.disabled = true;
            generateBtn.innerHTML = '<svg class="animate-spin -ml-1 mr-3 h-5 w-5 text-white" xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24"><circle class="opacity-25" cx="12" cy="12" r="10" stroke="currentColor" stroke-width="4"></circle><path class="opacity-75" fill="currentColor" d="M4 12a8 8 0 018-8V0C5.373 0 0 5.373 0 12h4zm2 5.291A7.962 7.962 0 014 12H0c0 3.042 1.135 5.824 3 7.938l3-2.647z"></path></svg> Generando...';

            setTimeout(() => {
                const size = parseInt(gridSizeSelect.value);
                // Usamos el t√≠tulo que el usuario haya puesto, que ya contiene el n√∫mero de sopa actual.
                const title = puzzleTitle.value.trim(); 
                const { grid, placedWords } = generatePuzzle(wordList, size);

                if (placedWords.length === 0 && wordList.length > 0) { 
                    showMessage("Advertencia: No se pudo colocar ninguna palabra en la cuadr√≠cula. Intenta con un tama√±o mayor, palabras m√°s cortas o menos palabras. A√∫n as√≠, se mostrar√° la cuadr√≠cula vac√≠a.");
                }

                renderPuzzle(grid, placedWords, title);
                
                // 1. Incrementa el contador para el siguiente puzzle (SOLICITADO: Solo aqu√≠)
                incrementPuzzleCount(); 
                // 2. Actualiza el campo de entrada inmediatamente con el nuevo n√∫mero
                puzzleTitle.value = `Sopa #${getNextPuzzleNumber()}`;
                
                printBtn.disabled = false;
                generateBtn.disabled = false;
                generateBtn.textContent = 'Generar Puzzle';
                
                // Desplazar a la zona de impresi√≥n
                printableArea.scrollIntoView({ behavior: 'smooth' });
            }, 300); // Peque√±o retraso para la animaci√≥n
        });

        printBtn.addEventListener('click', () => {
            window.print();
        });

        // Inicializar
        document.addEventListener('DOMContentLoaded', () => {
            renderWordListDisplay();
            populateFontSelector(); // Llenar el selector al cargar
            generateBtn.disabled = true; 
            
            // Establecer el valor inicial del t√≠tulo usando el contador de localStorage
            const nextNum = getNextPuzzleNumber();
            puzzleTitle.value = `Sopa #${nextNum}`;
        });

        // Asegurar que al cambiar el tama√±o del grid, las palabras se validan y se resetea la salida
        gridSizeSelect.addEventListener('change', () => {
            const newSize = parseInt(gridSizeSelect.value);
            let needsRemoval = false;

            for (let i = wordList.length - 1; i >= 0; i--) {
                if (wordList[i].length > newSize) {
                    wordList.splice(i, 1);
                    needsRemoval = true;
                }
            }

            if (needsRemoval) {
                renderWordListDisplay();
                showMessage(`Se han eliminado autom√°ticamente las palabras que exced√≠an el tama√±o m√°ximo de ${newSize}x${newSize}.`);
            }

            printableArea.style.display = 'none';
            printBtn.disabled = true;
            if (wordList.length > 0) {
                generateBtn.disabled = false;
            }
        });

    </script>
</body>
</html>