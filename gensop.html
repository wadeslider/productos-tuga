<!DOCTYPE html>
<html lang="es">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>The Puzzle</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <!-- Incluye todas las fuentes de Google Fonts -->
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;600;700&family=Permanent+Marker&family=Balsamiq+Sans&family=Alegreya+Sans&family=Lobster&family=Cabin+Sketch&family=Pacifico&family=Josefin+Sans&family=Handlee&family=Righteous&family=Roboto+Mono&display=swap" rel="stylesheet">
    <style>
        /* Estilo Base y Fondo Moderno */
        body {
            font-family: 'Inter', sans-serif;
            background-color: #eef2f5; 
            background-image: linear-gradient(135deg, #f8fafc 25%, transparent 25%), 
                              linear-gradient(225deg, #f8fafc 25%, transparent 25%), 
                              linear-gradient(45deg, #f8fafc 25%, transparent 25%), 
                              linear-gradient(315deg, #f8fafc 25%, #eef2f5 25%);
            background-position: 10px 0, 10px 0, 0 0, 0 0;
            background-size: 20px 20px;
            background-repeat: repeat;
            min-height: 100vh;
        }
        
        /* Font Classes (Aplicadas solo al t√≠tulo) */
        .font-permanent-marker { font-family: 'Permanent Marker', cursive !important; }
        .font-balsamiq-sans { font-family: 'Balsamiq Sans', cursive !important; }
        .font-alegreya-sans { font-family: 'Alegreya Sans', sans-serif !important; }
        .font-lobster { font-family: 'Lobster', cursive !important; }
        .font-cabin-sketch { font-family: 'Cabin Sketch', cursive !important; }
        .font-pacifico { font-family: 'Pacifico', cursive !important; }
        .font-josefin-sans { font-family: 'Josefin Sans', sans-serif !important; }
        .font-handlee { font-family: 'Handlee', cursive !important; }
        .font-righteous { font-family: 'Righteous', cursive !important; }
        .font-roboto-mono { font-family: 'Roboto Mono', monospace !important; }
        /* --- End Font Classes --- */

        /* Estilo espec√≠fico para la cuadr√≠cula */
        .grid-container {
            display: grid;
            border: 2px solid #000000; /* Borde negro */
            background-color: transparent; 
            box-shadow: 0 4px 12px rgba(0, 0, 0, 0.1);
            border-radius: 0.75rem; /* Esquinas redondeadas */
            overflow: hidden; 
        }
        .grid-cell {
            display: flex;
            justify-content: center;
            align-items: center;
            font-size: 0.8rem;
            font-weight: 700; 
            color: #000000; 
            padding: 0.1rem; 
            user-select: none;
            cursor: default;
            transition: background-color 0.1s ease-out; /* Para la animaci√≥n de "flash" */
        }

        /* Estilo para el t√≠tulo de la sopa */
        #outputTitle {
            font-size: 1.8rem; 
            letter-spacing: 0.1em;
            text-shadow: 3px 3px 6px rgba(0,0,0,0.15); 
            transition: all 0.3s ease;
        }

        /* ESTILOS DE PREVISUALIZACI√ìN EN PANTALLA Y EN IMPRESI√ìN (Lista de Palabras) */
        .word-list-preview {
            /* 3 Columnas */
            grid-template-columns: repeat(3, 1fr);
            font-size: 0.75rem; 
            gap-x: 0.75rem;
            gap-y: 0.3rem;
        }

        /* CUADRADO 3D SOLICITADO (Sombra Gris/Negra) */
        .checkbox-3d {
            height: 0.8rem;
            width: 0.8rem;
            background-color: transparent; 
            border-radius: 0.1rem; 
            flex-shrink: 0;
            box-shadow: 2px 2px 0 0 rgba(107, 114, 128, 0.7); 
        }

        /* Contenedor de lista e imagen (Flexbox para dividir 80/20) */
        .list-image-container {
            display: flex;
            align-items: flex-start; /* Alineaci√≥n superior para ambos */
            gap: 1rem;
            width: 100%;
        }

        .list-container {
            width: 80%; /* 80% del ancho para la lista */
        }

        .image-container {
            width: 20%; /* 20% del ancho para la imagen */
            display: flex;
            justify-content: center;
        }

        .image-container img {
            /* Modificaci√≥n para forzar 1:1 */
            width: 100%; /* Ocupa todo el 20% del contenedor */
            aspect-ratio: 1 / 1; /* FORZAR ASPECTO CUADRADO (1:1) */
            max-height: 100%; 
            
            border-radius: 0.5rem;
            box-shadow: 0 2px 8px rgba(0, 0, 0, 0.1);
            object-fit: cover; /* Recortar si es necesario para llenar el cuadrado */
        }

        /* ============================================== */
        /* MEDIA PRINT: Optimizaci√≥n para Impresi√≥n (A4) */
        /* ============================================== */
        @media print {
            .no-print { display: none !important; }
            body { 
                margin: 0 !important; 
                padding: 0 !important; 
                background: none !important; 
            }
            
            #app {
                background-color: transparent !important;
                box-shadow: none !important;
                border: none !important;
                padding: 0 !important;
                margin: 0 auto !important;
                max-width: none !important;
            }

            .printable-area {
                margin: 0 !important;
                padding: 0.25in !important; /* Margen de impresi√≥n ULTRA REDUCIDO (0.6 cm) */
                box-shadow: none !important;
                max-width: none !important;
                width: 100% !important;
                border: none !important;
                background-color: transparent !important; 
            }

            #outputTitle {
                font-size: 1.7rem !important; 
                margin-bottom: 0.5rem !important; 
                text-shadow: none;
                width: 100% !important;
            }

            /* Cuadr√≠cula - centrada y aspecto cuadrado */
            #puzzleOutput {
                width: 100% !important;
                max-width: 7in !important; /* Ancho t√≠pico de impresi√≥n */
                margin: 0 auto !important; 
            }

            .grid-container {
                border-width: 2px !important;
                border-color: #000 !important;
                border-radius: 0.75rem !important; 
                background-color: transparent !important; 
                box-shadow: none !important; 
            }

            .grid-cell {
                color: #000000 !important; 
                font-size: 0.8rem !important; 
                /* Desactivar cualquier color de fondo al imprimir */
                background-color: transparent !important; 
            }

            /* Contenedor de lista e imagen en impresi√≥n */
            #wordListContainer {
                margin-top: 0.5rem !important;
                background: none !important;
                border: none !important; 
                box-shadow: none !important;
                padding: 0 !important; 
                /* Asegurar que el contenedor principal est√© alineado y centrado */
                max-width: 7in !important; 
                margin: 0.5rem auto 0 auto !important;
            }
            
            /* Lista de Palabras en impresi√≥n */
            #wordListOutput {
                grid-template-columns: repeat(3, 1fr) !important;
                font-size: 0.75rem !important;
            }

            .checkbox-3d {
                height: 0.65rem !important;
                width: 0.65rem !important;
                box-shadow: 1.5px 1.5px 0 0 rgba(0, 0, 0, 0.7);
            }

            /* Ajuste de contenedores flex en impresi√≥n */
            .list-image-container {
                gap: 0.5rem !important; /* Espacio reducido */
            }
            .list-container { width: 80% !important; }
            .image-container { width: 20% !important; }
            .image-container img { 
                height: auto !important; 
                width: 100% !important;
                aspect-ratio: 1 / 1 !important; /* 1:1 en impresi√≥n */
            } 
        }
    </style>
</head>
<body class="p-4 sm:p-8">

    <!-- Contenedor principal con estilo flotante y moderno -->
    <div id="app" class="max-w-5xl mx-auto bg-white p-6 sm:p-10 rounded-3xl shadow-2xl transition duration-500 hover:shadow-3xl">

        <!-- √Årea de Control (No Imprimir) -->
        <div class="no-print">
            <!-- CAMBIO AQU√ç: The Puzzle en singular -->
            <h1 class="text-4xl font-extrabold text-gray-900 mb-2 flex items-center">
                <span class="text-indigo-600 mr-3 text-5xl">‚ú®</span> The Puzzle
            </h1>
            <p class="text-base text-gray-500 mb-8 border-b pb-4">Personaliza, genera e imprime tu puzzle con un acabado profesional.</p>

            <!-- Inputs y Configuraci√≥n -->
            <div class="space-y-6 mb-8 p-6 bg-gray-50 rounded-2xl border border-gray-100 shadow-inner">
                
                <!-- Secci√≥n 1: Configuraci√≥n General -->
                <div class="space-y-4">
                    <h2 class="text-xl font-bold text-gray-700 border-b pb-1">Configuraci√≥n del Puzzle (15 Palabras Requeridas)</h2>
                    <div class="flex flex-col md:flex-row space-y-4 md:space-y-0 md:space-x-4">
                        <!-- T√≠tulo (Siempre en may√∫sculas) -->
                        <input type="text" id="puzzleTitle" placeholder="T√çTULO DE LA SOPA DE LETRAS (EJ: FRUTAS)"
                            class="flex-1 p-3 border border-gray-300 rounded-xl focus:ring-indigo-500 focus:border-indigo-500 text-base shadow-sm transition uppercase">
                        
                        <!-- Selector de Formato (Ancho x Alto) -->
                        <select id="formatSelect"
                            class="p-3 border border-gray-300 rounded-xl focus:ring-indigo-500 focus:border-indigo-500 text-base shadow-sm w-full md:w-48 transition">
                            <option value="17x13" selected>Horizontal (17x13)</option>
                            <option value="12x16">Vertical (12x16)</option>
                        </select>

                        <!-- Selector de Fuente -->
                        <select id="fontSelect"
                            class="p-3 border border-gray-300 rounded-xl focus:ring-indigo-500 focus:border-indigo-500 text-base shadow-sm w-full md:w-56 transition">
                            <!-- Opciones pobladas por JS -->
                        </select>
                    </div>
                </div>

                <!-- Secci√≥n 2: Gesti√≥n de Palabras -->
                <div class="space-y-4 pt-4">
                    <h2 class="text-xl font-bold text-gray-700 border-b pb-1">Palabras a Incluir (<span id="wordCount">0/15</span>)</h2>
                    <div class="flex flex-col sm:flex-row space-y-3 sm:space-y-0 sm:space-x-4">
                        <input type="text" id="wordInput" placeholder="ESCRIBE UNA PALABRA Y PRESIONA ENTER O A√ëADIR (M√ÅX 15)"
                            class="flex-1 p-3 border border-gray-300 rounded-xl focus:ring-pink-500 focus:border-pink-500 text-base shadow-sm transition uppercase">
                        <button id="addWordBtn"
                            class="px-6 py-3 bg-pink-500 text-white font-semibold rounded-xl shadow-lg hover:bg-pink-600 transition duration-200 transform hover:scale-[1.03] active:scale-95 text-base">
                            + A√±adir
                        </button>
                    </div>

                    <!-- Lista de Palabras A√±adidas -->
                    <div id="wordListDisplay" class="flex flex-wrap gap-3 min-h-12 p-3 border-2 border-dashed border-gray-300 rounded-xl bg-white shadow-inner mt-4">
                        <p class="text-gray-400 italic text-sm" id="emptyMessage">A√±ade 15 palabras exactas. Intenta con "SOL", "LUNA", "ESTRELLA".</p>
                    </div>
                </div>

                <!-- Secci√≥n 3: Imagen y Posici√≥n -->
                <div class="space-y-4 pt-4">
                    <h2 class="text-xl font-bold text-gray-700 border-b pb-1">Imagen (Opcional)</h2>
                    <div class="flex flex-col md:flex-row space-y-4 md:space-y-0 md:space-x-4 items-center">
                        
                        <!-- Selector de Archivo -->
                        <div class="flex-1">
                            <label class="block text-sm font-medium text-gray-700 mb-1">Subir Imagen para el Puzzle (PNG/JPG) - Se forzar√° a 1:1</label>
                            <input type="file" id="imageUploader" accept="image/*"
                                class="w-full text-sm text-gray-500 file:mr-4 file:py-2 file:px-4 file:rounded-xl file:border-0 file:text-sm file:font-semibold file:bg-violet-50 file:text-violet-700 hover:file:bg-violet-100 transition duration-200">
                        </div>

                        <!-- Selector de Posici√≥n -->
                        <select id="imagePosition"
                            class="p-3 border border-gray-300 rounded-xl focus:ring-indigo-500 focus:border-indigo-500 text-base shadow-sm w-full md:w-48 transition">
                            <option value="right" selected>Imagen a la Derecha</option>
                            <option value="left">Imagen a la Izquierda</option>
                        </select>
                    </div>
                </div>
            </div>

            <!-- Botones de Acci√≥n Finales -->
            <div class="flex flex-col sm:flex-row justify-center space-y-4 sm:space-y-0 sm:space-x-6 mb-10">
                <button id="generateBtn"
                    class="w-1/2 mx-auto sm:mx-0 px-8 py-1 bg-indigo-500 text-white font-medium text-base rounded-xl shadow-md hover:bg-indigo-600 transition duration-300 transform hover:scale-[1.01] active:scale-95">
                    Generar Puzzle
                </button>
                <button id="printBtn"
                    class="w-1/2 mx-auto sm:mx-0 px-8 py-1 bg-green-500 text-white font-medium text-base rounded-xl shadow-md hover:bg-green-600 transition duration-300 transform hover:scale-[1.01] active:scale-95 disabled:bg-gray-400 flex items-center justify-center"
                    disabled>
                    <span class="text-lg mr-2" aria-hidden="true">üñ®Ô∏è</span>
                    Imprimir / Descargar PDF
                </button>
            </div>
            
        </div>

        <!-- √Årea Imprimible (Resultado) -->
        <div id="printableArea" class="printable-area p-4 sm:p-6 rounded-xl border border-gray-200 bg-white shadow-lg transition duration-500" style="display: none;">
            
            <!-- T√≠tulo -->
            <h1 id="outputTitle" class="text-3xl sm:text-4xl font-extrabold text-center mb-2 text-gray-900 uppercase font-permanent-marker w-full"></h1>
            
            <!-- Cuadr√≠cula (centrada en la pantalla) -->
            <!-- max-width y aspect-ratio se manejan din√°micamente en JS -->
            <div id="puzzleOutput" class="mx-auto" style="max-width: 600px;">
                <!-- Aqu√≠ se renderizar√° la cuadr√≠cula --></div>
            
            <!-- Contenedor de Lista de Palabras e Imagen -->
            <div id="wordListContainer" class="list-image-container mt-2 mx-auto p-4 rounded-xl" style="max-width: 600px;">
                
                <!-- La estructura se rellena y se reordena con JS -->
                
            </div>
            
        </div>

        <!-- √Årea de Mensajes (Modal) -->
        <div id="messageBox" class="fixed inset-0 bg-black bg-opacity-60 flex items-center justify-center p-4 z-50 hidden transition-opacity duration-300">
            <div class="bg-white p-8 rounded-xl shadow-2xl max-w-md w-full text-center transform transition-transform duration-300 scale-95" id="messageContent">
                <p id="messageText" class="text-xl font-semibold text-gray-800 mb-6"></p>
                <button id="closeMessageBtn" class="px-6 py-2 bg-indigo-500 text-white font-semibold rounded-lg hover:bg-indigo-600 transition duration-150 shadow-md">Aceptar</button>
            </div>
        </div>

    </div>

    <script type="module">
        // =========================================================================
        // Configuraci√≥n y Variables Globales
        // =========================================================================
        const MAX_WORDS = 15;
        const wordList = [];
        // CAMBIO AQU√ç: Ahora dice "The Puzzle" en la imagen de reemplazo
        const DEFAULT_IMAGE_URL = 'https://placehold.co/150x150/000000/ffffff?text=The+Puzzle'; 
        // Alfabeto extendido para incluir √ë y vocales acentuadas
        const alphabet = 'ABCDEFGHIJKLMNOPQRSTUVWXYZ√ë√Å√â√ç√ì√ö'; 
        const DIRECTIONS = [
            [0, 1],   // Este (E)
            [1, 0],   // Sur (S)
            [0, -1],  // Oeste (W)
            [-1, 0],  // Norte (N)
            [1, 1],   // Sureste (SE)
            [-1, 1],  // Noreste (NE)
            [1, -1],  // Suroeste (SW)
            [-1, -1]  // Noroeste (NW)
        ];
        
        // NOMBRES SIMPLIFICADOS para el selector
        const FONT_OPTIONS = {
            'Permanent Marker': 'Marcador',
            'Balsamiq Sans': 'Juguet√≥n',
            'Alegreya Sans': 'Clara',
            'Lobster': 'Decorativa',
            'Cabin Sketch': 'Boceto',
            'Pacifico': 'Manuscrita',
            'Josefin Sans': 'Geom√©trica',
            'Handlee': 'Escrita a mano',
            'Righteous': 'Fuerte',
            'Roboto Mono': 'Monospacio'
        };
        const DEFAULT_FONT_CLASS = 'font-permanent-marker';
        const PUZZLE_COUNT_KEY = 'puzzleCount'; 


        // Referencias a elementos del DOM
        const wordInput = document.getElementById('wordInput');
        const wordListDisplay = document.getElementById('wordListDisplay');
        const emptyMessage = document.getElementById('emptyMessage');
        const puzzleTitle = document.getElementById('puzzleTitle');
        const generateBtn = document.getElementById('generateBtn');
        const printBtn = document.getElementById('printBtn');
        const puzzleOutput = document.getElementById('puzzleOutput');
        const outputTitle = document.getElementById('outputTitle');
        const wordListOutput = document.getElementById('wordListOutput');
        const formatSelect = document.getElementById('formatSelect'); 
        const printableArea = document.getElementById('printableArea');
        const messageBox = document.getElementById('messageBox');
        const messageText = document.getElementById('messageText');
        const closeMessageBtn = document.getElementById('closeMessageBtn');
        const fontSelect = document.getElementById('fontSelect'); 
        const wordListContainer = document.getElementById('wordListContainer');
        const wordCountSpan = document.getElementById('wordCount');
        const imageUploader = document.getElementById('imageUploader');
        const imagePositionSelect = document.getElementById('imagePosition');

        let currentImageURL = DEFAULT_IMAGE_URL;
        let originalDocumentTitle = document.title;
        
        // =========================================================================
        // L√≥gica de Contador de Puzzles (Local Storage)
        // =========================================================================

        function getNextPuzzleNumber() {
            let currentCount = parseInt(localStorage.getItem(PUZZLE_COUNT_KEY) || '0', 10);
            return currentCount;
        }

        function incrementPuzzleCount() {
            let currentCount = getNextPuzzleNumber();
            let newCount = currentCount + 1;
            localStorage.setItem(PUZZLE_COUNT_KEY, newCount.toString());
        }

        // =========================================================================
        // L√≥gica de UI - Mensajes y Palabras
        // =========================================================================
        
        function showMessage(text) {
            messageText.textContent = text;
            messageBox.classList.remove('hidden');
            document.getElementById('messageContent').classList.remove('scale-95');
            document.getElementById('messageContent').classList.add('scale-100');
        }

        closeMessageBtn.addEventListener('click', () => {
            document.getElementById('messageContent').classList.remove('scale-100');
            document.getElementById('messageContent').classList.add('scale-95');
            setTimeout(() => {
                messageBox.classList.add('hidden');
            }, 300); 
        });

        function formatWord(word) {
            // Limpia y convierte a may√∫sculas. Ahora permite √ë y vocales acentuadas.
            return word.toUpperCase().replace(/[^A-Z√ë√Å√â√ç√ì√ö]/g, '');
        }

        function updateWordCount() {
            wordCountSpan.textContent = `${wordList.length}/${MAX_WORDS}`;
            // Cambiar color si est√° fuera del l√≠mite (solo si es diferente a 15)
            if (wordList.length === MAX_WORDS) {
                wordCountSpan.classList.remove('text-red-500');
                wordCountSpan.classList.add('text-green-600');
                generateBtn.disabled = false;
            } else {
                wordCountSpan.classList.remove('text-green-600');
                wordCountSpan.classList.add('text-red-500');
                generateBtn.disabled = true;
            }
        }

        function addWord() {
            let word = wordInput.value.trim(); 
            if (word.length === 0) {
                showMessage("Por favor, introduce una palabra v√°lida.");
                return;
            }

            const cleanWord = formatWord(word);
            // El tama√±o m√°ximo ahora depende del formato seleccionado
            const [width, height] = formatSelect.value.split('x').map(Number);
            const maxLen = Math.max(width, height); 

            if (cleanWord.length === 0) {
                showMessage("La palabra solo debe contener letras (A-Z, √ë, √Å, √â, √ç, √ì, √ö).");
                return;
            }

            if (wordList.length >= MAX_WORDS) {
                showMessage(`Solo se permiten ${MAX_WORDS} palabras. Por favor, elimina una para a√±adir otra.`);
                return;
            }

            if (cleanWord.length > maxLen) {
                showMessage(`La palabra es demasiado larga (${cleanWord.length} letras). El tama√±o m√°ximo para el formato seleccionado es ${maxLen}.`);
                return;
            }

            if (wordList.includes(cleanWord)) {
                showMessage("Esta palabra ya ha sido a√±adida.");
                return;
            }

            wordList.push(cleanWord);
            wordInput.value = '';
            renderWordListDisplay();
            updateWordCount();
        }

        function removeWord(wordToRemove) {
            const index = wordList.indexOf(wordToRemove);
            if (index > -1) {
                wordList.splice(index, 1);
            }
            renderWordListDisplay();
            updateWordCount();

            if (wordList.length !== MAX_WORDS) {
                printBtn.disabled = true;
                printableArea.style.display = 'none';
            }
        }

        function renderWordListDisplay() {
            wordListDisplay.innerHTML = '';
            if (wordList.length === 0) {
                wordListDisplay.appendChild(emptyMessage);
                emptyMessage.classList.remove('hidden');
            } else {
                emptyMessage.classList.add('hidden');
                wordList.forEach(word => {
                    const tag = document.createElement('span');
                    tag.className = 'flex items-center bg-pink-100 text-pink-800 text-sm font-medium px-4 py-1 rounded-full cursor-pointer shadow-md hover:bg-pink-200 transition duration-150';
                    tag.innerHTML = `${word} <button class="ml-2 text-pink-600 hover:text-red-700 font-bold leading-none text-xl" data-word="${word}">&times;</button>`;
                    tag.querySelector('button').addEventListener('click', (e) => removeWord(e.target.dataset.word));
                    wordListDisplay.appendChild(tag);
                });
            }
        }

        // =========================================================================
        // Algoritmo de Generaci√≥n de Sopa de Letras
        // =========================================================================
        // Grid ya no es cuadrado. Recibe Ancho y Alto.
        function createEmptyGrid(width, height) {
            return Array.from({ length: height }, () => Array(width).fill(''));
        }

        // El algoritmo de colocaci√≥n debe usar (X, Y) donde X es FILA (height) y Y es COLUMNA (width)
        function placeWord(grid, word, width, height) {
            for (let attempts = 0; attempts < 500; attempts++) {
                // Fila inicial (X) y Columna inicial (Y)
                const startX = Math.floor(Math.random() * height);
                const startY = Math.floor(Math.random() * width);
                const [dx, dy] = DIRECTIONS[Math.floor(Math.random() * DIRECTIONS.length)];
                
                let fits = true;
                
                // 1. Verificar si cabe
                const endX = startX + (word.length - 1) * dx;
                const endY = startY + (word.length - 1) * dy;

                if (endX < 0 || endX >= height || endY < 0 || endY >= width) {
                    continue; 
                }

                // 2. Verificar si no hay conflicto
                for (let i = 0; i < word.length; i++) {
                    const x = startX + i * dx;
                    const y = startY + i * dy;
                    
                    if (grid[x][y] !== '' && grid[x][y] !== word[i]) {
                        fits = false;
                        break;
                    }
                }

                // 3. Colocar la palabra
                if (fits) {
                    for (let i = 0; i < word.length; i++) {
                        const x = startX + i * dx;
                        const y = startY + i * dy;
                        grid[x][y] = word[i];
                    }
                    return true;
                }
            }
            return false; 
        }

        function generatePuzzle(words, width, height) {
            const grid = createEmptyGrid(width, height);
            const placedWords = [];

            const sortedWords = [...words].sort((a, b) => b.length - a.length);

            sortedWords.forEach(word => {
                const maxLen = Math.max(width, height);
                if (word.length <= maxLen) {
                    if (placeWord(grid, word, width, height)) {
                        placedWords.push(word);
                    } else {
                        console.warn(`No se pudo colocar la palabra: ${word}`);
                    }
                }
            });

            // Rellenar espacios vac√≠os
            for (let i = 0; i < height; i++) {
                for (let j = 0; j < width; j++) {
                    if (grid[i][j] === '') {
                        grid[i][j] = alphabet.charAt(Math.floor(Math.random() * alphabet.length));
                    }
                }
            }
            
            return { grid, placedWords };
        }

        // =========================================================================
        // L√≥gica de Renderizado
        // =========================================================================

        function renderPuzzle(grid, placedWords, title, width, height) {
            
            outputTitle.textContent = title.toUpperCase() || "SOPA DE LETRAS";
            
            // Aplicar la fuente seleccionada SOLO al t√≠tulo
            outputTitle.className = outputTitle.className.split(' ').filter(c => !c.startsWith('font-')).join(' ');
            outputTitle.classList.add(fontSelect.value, 'text-3xl', 'sm:text-4xl', 'font-extrabold', 'text-center', 'mb-2', 'text-gray-900', 'uppercase', 'w-full');

            // 1. Renderizar la cuadr√≠cula
            puzzleOutput.innerHTML = '';
            puzzleOutput.style.gridTemplateColumns = `repeat(${width}, 1fr)`;
            puzzleOutput.style.aspectRatio = `${width} / ${height}`; 
            puzzleOutput.className = 'grid-container mx-auto'; 
            
            grid.forEach(row => {
                row.forEach(letter => {
                    const cell = document.createElement('div');
                    cell.className = 'grid-cell';
                    cell.textContent = letter;
                    puzzleOutput.appendChild(cell);
                    
                    // A√±adir animaci√≥n de "flash" (resplandor amarillo)
                    setTimeout(() => {
                        cell.style.backgroundColor = '#fef3c7'; // yellow-100
                        setTimeout(() => {
                            cell.style.backgroundColor = 'transparent'; // Resetear color (CSS transition se encarga de la suavidad)
                        }, 100);
                    }, Math.random() * 50); // Peque√±o retraso para efecto "cascada"
                });
            });
            
            // 2. Renderizar Lista de Palabras e Imagen (Flex 80/20)
            wordListContainer.innerHTML = '';
            
            // Elemento de la Lista (80% de ancho)
            const listDiv = document.createElement('div');
            listDiv.className = 'list-container';
            listDiv.innerHTML = `<div id="wordListOutputPrint" class="word-list-preview text-gray-800 grid"></div>`;
            
            // Elemento de la Imagen (20% de ancho)
            const imageDiv = document.createElement('div');
            imageDiv.className = 'image-container';
            // Importante: La imagen se forzar√° a 1:1 por CSS
            imageDiv.innerHTML = `<img id="wordListImage" src="${currentImageURL}" alt="Imagen del Puzzle" onerror="this.onerror=null; this.src='${DEFAULT_IMAGE_URL}'">`;

            // Colocar los elementos seg√∫n la posici√≥n seleccionada
            if (imagePositionSelect.value === 'left') {
                wordListContainer.appendChild(imageDiv);
                wordListContainer.appendChild(listDiv);
            } else { // right (por defecto)
                wordListContainer.appendChild(listDiv);
                wordListContainer.appendChild(imageDiv);
            }

            // Llenar la lista
            const listOutputElement = listDiv.querySelector('#wordListOutputPrint');
            placedWords.sort().forEach(word => {
                const item = document.createElement('div');
                item.className = 'flex items-center text-sm font-medium tracking-wider text-gray-800 space-x-2'; 
                item.innerHTML = `<span class="checkbox-3d flex-shrink-0"></span><span class="truncate">${word}</span>`;
                listOutputElement.appendChild(item);
            });
            
            printableArea.style.display = 'block'; 
        }

        // =========================================================================
        // Manejadores de Eventos
        // =========================================================================
        
        function populateFontSelector() {
            for (const key in FONT_OPTIONS) {
                const option = document.createElement('option');
                option.value = `font-${key.toLowerCase().replace(/ /g, '-')}`;
                option.textContent = FONT_OPTIONS[key]; 
                if (option.value === DEFAULT_FONT_CLASS) {
                    option.selected = true;
                }
                fontSelect.appendChild(option);
            }
        }

        document.getElementById('addWordBtn').addEventListener('click', addWord);
        
        // Listener para convertir a may√∫sculas al escribir en la palabra
        wordInput.addEventListener('input', (e) => {
            e.target.value = e.target.value.toUpperCase();
        });

        // Listener para convertir a may√∫sculas al escribir en el t√≠tulo
        puzzleTitle.addEventListener('input', (e) => {
            e.target.value = e.target.value.toUpperCase();
        });

        wordInput.addEventListener('keydown', (e) => {
            if (e.key === 'Enter') {
                e.preventDefault();
                addWord();
            }
        });

        // Listener para la carga de imagen
        imageUploader.addEventListener('change', (e) => {
            const file = e.target.files[0];
            if (file) {
                // Limpiar URL anterior si existe para evitar p√©rdidas de memoria
                if (currentImageURL && currentImageURL.startsWith('blob:')) {
                    URL.revokeObjectURL(currentImageURL);
                }
                currentImageURL = URL.createObjectURL(file);
            } else {
                currentImageURL = DEFAULT_IMAGE_URL;
            }
            // Si el puzzle ya est√° visible, actualizar la imagen inmediatamente
            const imgElement = document.getElementById('wordListImage');
            if (imgElement) {
                imgElement.src = currentImageURL;
            }
        });

        generateBtn.addEventListener('click', () => {
            if (wordList.length !== MAX_WORDS) {
                showMessage(`Debes ingresar exactamente ${MAX_WORDS} palabras para generar el puzzle.`);
                return;
            }
            
            generateBtn.disabled = true;
            generateBtn.innerHTML = '<svg class="animate-spin -ml-1 mr-3 h-5 w-5 text-white" xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24"><circle class="opacity-25" cx="12" cy="12" r="10" stroke="currentColor" stroke-width="4"></circle><path class="opacity-75" fill="currentColor" d="M4 12a8 8 0 018-8V0C5.373 0 0 5.373 0 12h4zm2 5.291A7.962 7.962 0 014 12H0c0 3.042 1.135 5.824 3 7.938l3-2.647z"></path></svg> Generando...';

            setTimeout(() => {
                const [width, height] = formatSelect.value.split('x').map(Number);
                const title = puzzleTitle.value.trim(); 
                const { grid, placedWords } = generatePuzzle(wordList, width, height);

                if (placedWords.length === 0 && wordList.length > 0) { 
                    showMessage("Advertencia: No se pudo colocar la mayor√≠a de las palabras. Intenta palabras m√°s cortas o revisa si se solapan mucho.");
                }

                renderPuzzle(grid, placedWords, title, width, height);
                
                // Actualizaciones de estado
                incrementPuzzleCount(); 
                puzzleTitle.value = `SOPA #${getNextPuzzleNumber()}`;
                
                printBtn.disabled = false;
                generateBtn.disabled = false;
                generateBtn.textContent = 'Generar Puzzle';
                
                printableArea.scrollIntoView({ behavior: 'smooth' });
            }, 300); 
        });

        printBtn.addEventListener('click', () => {
            // L√≥gica para cambiar el nombre del archivo PDF
            const titleText = puzzleTitle.value.trim();
            if (titleText) {
                originalDocumentTitle = document.title; 
                // Limpia el t√≠tulo para evitar caracteres no v√°lidos en el nombre del archivo
                document.title = titleText.replace(/[^a-zA-Z0-9\s]/g, '').trim().toUpperCase();
            }
            
            window.print();

            setTimeout(() => {
                document.title = originalDocumentTitle;
            }, 500); 
        });

        // Inicializar
        document.addEventListener('DOMContentLoaded', () => {
            renderWordListDisplay();
            populateFontSelector(); 
            updateWordCount(); // Inicializa el contador
            
            const nextNum = getNextPuzzleNumber();
            puzzleTitle.value = `SOPA #${nextNum}`;
            
            originalDocumentTitle = document.title;
        });

    </script>
</body>
</html>